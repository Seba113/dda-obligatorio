<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Propietarios</title>
    <link rel="stylesheet" href="panel-propietarios.css">
    <script src="vistaWeb.js"></script>
</head>

<body>
    <script src="sse.js"></script>
    <script src="utilesVista.js"></script>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 id="titulo">üìä Tablero de control del propietario</h1>
            <button class="btn-salir" onclick="salir()">Salir</button>
        </div>

        <!-- Resumen del propietario -->
        <div class="section">
            <div class="section-title">Resumen del propietario</div>
            <div class="resumen">
                <div class="resumen-item">
                    <span class="resumen-label">Nombre Completo</span>
                    <span class="resumen-value" id="nombrePropietario"></span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Estado</span>
                    <span class="resumen-value estado-activo" id="estadoPropietario"></span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Saldo Actual</span>
                    <span class="resumen-value saldo-amount" id="saldoPropietario"></span>
                </div>
            </div>
        </div>

        <!-- Grid: Bonificaciones y Veh√≠culos -->
        <div class="grid-2col">
            <!-- Bonificaciones asignadas -->
            <div class="section">
                <div class="section-title">Bonificaciones asignadas</div>
                <table>
                    <tbody id="tablaBonificaciones"></tbody>
                </table>
            </div>

            <!-- Veh√≠culos registrados -->
            <div class="section">
                <div class="section-title">Veh√≠culos registrados</div>
                <table>
                    <tbody id="tablaVehiculos"></tbody>
                </table>
            </div>
        </div>

        <!-- Tr√°nsitos realizados -->
        <div class="section">
            <div class="section-title">Tr√°nsitos realizados</div>
            <table>
                <tbody id="tablaTransitos"></tbody>
            </table>
        </div>

        <!-- Notificaciones del sistema -->
        <div class="section">
            <div class="notificaciones-header">
                <div class="section-title" style="margin: 0; padding: 0; border: none;">Notificaciones del sistema</div>

            </div>
            <div id="listaNotificaciones"></div>
            <button class="btn-borrar" onclick="borrarNotificaciones()">Borrar notificaciones</button>
        </div>
    </div>


</body>



<script>

    var urlIniciarVista = "/propietario/tablero";
    var parametrosInicioVista = "";
    var urlRegistroSSE = "/propietario/registrarSSE";
    var urlCierreVista = "/propietario/cerrar";

    const URL_SALIR = "acceso/logoutPeaje";


    // Helper para formatear datos antes de pasarlos a crearTablaDesdeJson
    function formatearDatos(lista, tipo) {
        if (!Array.isArray(lista)) return [];

        switch (tipo) {
            case 'bonificaciones':
                return lista.map(b => ({
                    bonificacion: b.nombreBonificacion || '',
                    puesto: b.nombrePuesto || '',
                    fechaAsignada: b.fechaAsignada ? new Date(b.fechaAsignada).toLocaleDateString() : ''
                }));

            case 'vehiculos':
                return lista.map(v => ({
                    matricula: v.matricula || '',
                    modelo: v.modelo || '',
                    color: v.color || '',
                    transitos: v.cantidadTransitos || 0,
                    montoTotal: '$ ' + Number(v.montoTotal || 0).toFixed(2)
                }));

            case 'transitos':
                return lista.map(t => ({
                    puesto: t.puesto || '',
                    matricula: t.matricula || '',
                    tarifa: t.tarifa || '',
                    montoTarifa: '$ ' + Number(t.montoTarifa || 0).toFixed(2),
                    bonificacion: t.bonificacion || '',
                    montoBonificacion: t.montoBonificacion ? '-$ ' + Math.abs(Number(t.montoBonificacion)).toFixed(2) : '',
                    montoPagado: '$ ' + Number(t.montoPagado || 0).toFixed(2),
                    fecha: t.fecha ? new Date(t.fecha).toLocaleDateString() : '',
                    hora: t.hora || ''
                }));

            default:
                return lista;
        }
    }

    // Handlers que procesan las respuestas del backend: mostrar_<id>
    function mostrar_resumen(param) {
        if (!param) return;
        document.getElementById('nombrePropietario').textContent = param.nombreCompleto || '';
        document.getElementById('estadoPropietario').textContent = param.estado || '';
        document.getElementById('saldoPropietario').textContent = param.saldoActual != null ? '$ ' + Number(param.saldoActual).toFixed(2) : '';
    }

    function mostrar_bonificaciones(lista) {
        const tbody = document.getElementById('tablaBonificaciones');
        const datosFormateados = formatearDatos(lista, 'bonificaciones');
        tbody.innerHTML = datosFormateados.length > 0
            ? crearTablaDesdeJson(datosFormateados)
            : '<tr><td colspan="3" class="empty-message">No hay bonificaciones asignadas.</td></tr>';
    }

    function mostrar_vehiculos(lista) {
        const tbody = document.getElementById('tablaVehiculos');
        const datosFormateados = formatearDatos(lista, 'vehiculos');
        tbody.innerHTML = datosFormateados.length > 0
            ? crearTablaDesdeJson(datosFormateados)
            : '<tr><td colspan="5" class="empty-message">No hay veh√≠culos registrados.</td></tr>';
    }

    function mostrar_transitos(lista) {
        const tbody = document.getElementById('tablaTransitos');
        const datosFormateados = formatearDatos(lista, 'transitos');
        tbody.innerHTML = datosFormateados.length > 0
            ? crearTablaDesdeJson(datosFormateados)
            : '<tr><td colspan="9" class="empty-message">No hay tr√°nsitos para mostrar.</td></tr>';
    }

    function mostrar_notificaciones(lista) {
        const cont = document.getElementById('listaNotificaciones');
        if (!Array.isArray(lista) || lista.length === 0) {
            cont.innerHTML = '<div class="empty-message">No hay notificaciones.</div>';
            return;
        }
        cont.innerHTML = '';
        lista.forEach(n => {
            const div = document.createElement('div');
            div.className = 'notificacion-item';
            div.innerHTML = `
                <div class="notificacion-fecha">${n.fechaHora ? new Date(n.fechaHora).toLocaleString() : ''}</div>
                <div class="notificacion-mensaje">${n.mensaje || ''}</div>
            `;
            cont.appendChild(div);
        });
    }

    function mostrar_exito(msg) {
        console.log('√âxito:', msg);
    }

    function mostrar_error(msg) {
        mostrarMensaje(msg || 'Se produjo un error');
    }

    function mostrar_paginaLogin(url) {
        window.location.href = url || '/login-propietarios';
    }


    function procesarErrorSubmit(status, text) {
        if (status === 400) {
            window.location.href = 'login-propietarios.html';
        }
    }

    function salir() {
        submit(URL_SALIR, '');
    }

    function borrarNotificaciones() {
        submit('/propietario/borrarNotificaciones', '');
    }

    // Export helpers for console/testing
    window.borrarNotificaciones = borrarNotificaciones;
    window.salir = salir;
</script>

</html>