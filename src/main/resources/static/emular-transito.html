<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emular Transito</title>
    <link rel="stylesheet" href="emular-transito.css">
    <script src="vistaWeb.js"></script>
    <script src="utilesVista.js"></script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>游뚱</span>
                Emular tr치nsito
            </h1>
            <p>Seleccione un puesto, verifique las tarifas, ingrese la matr칤cula y emule un tr치nsito.</p>
        </div>

        <!-- Formulario -->
        <div class="form-container" data-controller="/emular">
            <form id="emularForm">

                <!-- Puesto -->
                <div class="form-group">
                    <label for="nombrePuesto">Puesto</label>
                    <div id="puestosContainer"></div>
                </div>

                <!-- Tarifas del puesto -->
                <div class="form-group" id="tarifasContainer" style="display: none;">
                    <label>Tarifas del puesto</label>
                    <div id="tarifasTabla"></div>
                    <p class="helper-text">Se muestran categor칤a y monto actuales del puesto seleccionado.</p>
                </div>

                <!-- Matr칤cula -->
                <div class="form-group">
                    <label for="matricula">Matr칤cula</label>
                    <input type="text" id="matricula" name="matricula" placeholder="Ej: ABC1234" maxlength="7" required>
                </div>

                <!-- Fecha y hora -->
                <div class="form-group">
                    <label for="fechaHora">Fecha y hora del tr치nsito</label>
                    <input type="datetime-local" id="fechaHora" name="fechaHora" required>
                    <p class="helper-text">Ej: 2025-11-19T15:30</p>
                </div>

                <!-- Bot칩n emular -->
                <button class="btn-emular" type="button" onclick="emularTransito()">Emular tr치nsito</button>

                <!-- Mensaje de error -->
                <div class="error-message" id="errorMessage"></div>

                
                </div>
            </form>
            <!-- Resultado -->
                <div class="resultado" id="resultado" style="display: none;">
                    <h3>Resultado</h3>
                    <div class="resultado-item">
                        <span class="resultado-label">Propietario:</span>
                        <span class="resultado-value" id="resPropietario"></span>
                    </div>
                    <div class="resultado-item">
                        <span class="resultado-label">Estado:</span>
                        <span class="resultado-value" id="resEstado"></span>
                    </div>
                    <div class="resultado-item">
                        <span class="resultado-label">Categor칤a:</span>
                        <span class="resultado-value" id="resCategoria"></span>
                    </div>
                    <div class="resultado-item">
                        <span class="resultado-label">Bonificaci칩n:</span>
                        <span class="resultado-value" id="resBonificacion"></span>
                    </div>
                    <div class="resultado-item">
                        <span class="resultado-label">Costo del tr치nsito:</span>
                        <span class="resultado-value" id="resCosto"></span>
                    </div>
                    <div class="resultado-item">
                        <span class="resultado-label">Saldo luego del tr치nsito:</span>
                        <span class="resultado-value" id="resSaldo"></span>
                    </div>
        </div>
    </div>

    <script>
        // Al cargar: pedir puestos
        window.onload = function () {
            submit("/emular/obtenerPuestos", "");
        };

        // Mostrar lista de puestos usando crearListaDesdeJson
        function mostrar_puestos(puestos) {
            const html = crearListaDesdeJson({
                data: puestos,
                campoMostrar: 'nombre',
                campoValor: 'nombre',
                multiple: false,
                mostrarOpcionInicial: true,
                id: 'nombrePuesto',
                onSelectItem: function (_, objeto) {
                    cargarTarifas(objeto.nombre);
                }
            });
            document.getElementById('puestosContainer').innerHTML = html;
        }

        // Cargar tarifas del puesto seleccionado
        function cargarTarifas(nombrePuesto) {
            const valor = nombrePuesto || (document.getElementById('nombrePuesto') ? document.getElementById('nombrePuesto').value : "");
            const container = document.getElementById('tarifasContainer');
            if (!valor) {
                container.style.display = 'none';
                document.getElementById('tarifasTabla').innerHTML = '';
                return;
            }
            submit('/emular/obtenerTarifasPuesto', 'nombrePuesto=' + encodeURIComponent(valor));
        }

        function mostrar_error(mensaje) {
            const el = document.getElementById('errorMessage');
            el.textContent = mensaje || '';
            if (mensaje) el.classList.add('show'); else el.classList.remove('show');
        }

        // Manejo de errores HTTP (evita alert gen칠rico y muestra en la vista)
        function procesarErrorSubmit(status, text){
            const msg = `Error ${status}: ${text}`;
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.classList.add('show');
            document.getElementById('resultado').style.display = 'none';
        }

        // Seleccionar el puesto devuelto por el servidor (si corresponde)
        function mostrar_puesto(puesto) {
            try {
                if (puesto && puesto.nombre) {
                    seleccionarPorTexto('nombrePuesto', puesto.nombre);
                }
            } catch (e) {
            }
        }

        // Mostrar tabla de tarifas usando crearTablaDesdeJson
        function mostrar_tarifas(tarifas) {
            const container = document.getElementById('tarifasContainer');
            const data = Array.isArray(tarifas) ? tarifas.map(t => ({
                categoria: t.categoria && t.categoria.nombre ? t.categoria.nombre : '',
                monto: (typeof t.monto === 'number') ? ('$ ' + t.monto.toFixed(2)) : t.monto
            })) : [];
            document.getElementById('tarifasTabla').innerHTML = crearTablaDesdeJson(data);
            container.style.display = data.length ? 'block' : 'none';
        }

        function emularTransito() {
            // Validaci칩n expl칤cita de campos y armado de payload URL-encoded
            const sel = document.getElementById('nombrePuesto');
            const nombrePuesto = sel ? sel.value : '';
            const matricula = (document.getElementById('matricula')?.value || '').trim();
            const fechaHora = (document.getElementById('fechaHora')?.value || '').trim();

            if (!nombrePuesto || nombrePuesto === '-1' || !matricula || !fechaHora) {
                const el = document.getElementById('errorMessage');
                el.textContent = 'Por favor complete todos los campos y seleccione un puesto v치lido';
                el.classList.add('show');
                document.getElementById('resultado').style.display = 'none';
                return;
            }

            const data =
                'nombrePuesto=' + encodeURIComponent(nombrePuesto) +
                '&matricula=' + encodeURIComponent(matricula) +
                '&fechaHora=' + encodeURIComponent(fechaHora);

            const el = document.getElementById('errorMessage');
            el.textContent = '';
            el.classList.remove('show');
            submit('/emular/emularTransitoSimple', data);
        }

        function mostrar_exito(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = '';
            el.classList.remove('show');
            document.getElementById('resultado').style.display = 'block';
        }

        function mostrar_propietario(nombreCompleto) {
            document.getElementById('resPropietario').textContent = nombreCompleto;
            document.getElementById('resultado').style.display = 'block';
        }

        function mostrar_estado(estado) {
            document.getElementById('resEstado').textContent = estado;
        }

        function mostrar_categoria(categoria) {
            document.getElementById('resCategoria').textContent = categoria;
        }

        function mostrar_bonificacion(bonif) {
            document.getElementById('resBonificacion').textContent = bonif && bonif !== '-' ? bonif : 'Sin bonificaci칩n (0%)';
        }

        function mostrar_montoFinal(monto) {
            const val = (typeof monto === 'number') ? monto.toFixed(2) : monto;
            document.getElementById('resCosto').textContent = '$ ' + val;
        }

        function mostrar_saldoActual(saldo) {
            const val = (typeof saldo === 'number') ? saldo.toFixed(2) : saldo;
            document.getElementById('resSaldo').textContent = '$ ' + val;
        }
    </script>

</body>

</html>